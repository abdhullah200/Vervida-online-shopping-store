@using Microsoft.AspNetCore.Html
@model List<Product>
@{
    ViewData["Title"] = "Products";
    var categories = ViewBag.Categories as List<string> ?? new List<string>();
    var selectedCategory = ViewBag.SelectedCategory as string;
    var search = ViewBag.Search as string;
}

<div class="container py-4">
    <h2 class="mb-4">Products</h2>
    <div class="row mb-3">
        <div class="col-md-4">
            <select id="categoryFilter" class="form-select">
                <option value="">All Categories</option>
                @foreach (var cat in categories)
                {
                    if (cat == selectedCategory)
                    {
                        <option value="@cat" selected>@cat</option>
                    }
                    else
                    {
                        <option value="@cat">@cat</option>
                    }
                }
            </select>
        </div>
        <div class="col-md-8">
            <input id="searchBox" class="form-control" placeholder="Search products..." value="@search" />
        </div>
    </div>
    @if (ViewBag.Error != null)
    {
        <div class="alert alert-danger">@ViewBag.Error</div>
    }
    else if (Model == null || !Model.Any())
    {
        <div class="alert alert-warning">No products available.</div>
    }
    else
    {
        <div class="row">
            @foreach (var product in Model)
            {
                <div class="col-md-4 mb-4">
                    <div class="card card-3d h-100" data-id="@product.Id">
                        <img src="@product.Image" class="card-img-top" alt="@product.Title" style="max-height:200px;object-fit:contain;">
                        <div class="card-body">
                            <h5 class="card-title">@Highlight(product.Title, search ?? string.Empty)</h5>
                            <p class="card-text">@product.Description</p>
                            <p class="card-text"><strong>$@product.Price</strong></p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-secondary">@product.Category</span>
                                <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); addToCart(@product.Id)">Add to cart</button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        <nav>
            <ul class="pagination justify-content-center">
                @for (int i = 1; i <= Math.Ceiling((double)ViewBag.TotalCount / 10); i++)
                {
                    <li class="page-item @(i == (ViewBag.Page ?? 1) ? "active" : "")">
                        <a class="page-link" href="?category=@selectedCategory&search=@search&page=@i">@i</a>
                    </li>
                }
            </ul>
        </nav>
    }
</div>

@section Scripts {
<script src="~/js/products.js" asp-append-version="true"></script>

<script>

document.addEventListener('DOMContentLoaded', function() {
    const searchBox = document.getElementById('searchBox');
    const categoryFilter = document.getElementById('categoryFilter');
    
    function performSearch() {
        const searchTerm = searchBox?.value || '';
        const category = categoryFilter?.value || '';
        
        const url = new URL(window.location);
        
        if (searchTerm) {
            url.searchParams.set('search', searchTerm);
        } else {
            url.searchParams.delete('search');
        }
        
        if (category) {
            url.searchParams.set('category', category);
        } else {
            url.searchParams.delete('category');
        }
        
        url.searchParams.delete('page');
        window.location.href = url.toString();
    }
    
    // Search on Enter key
    if (searchBox) {
        searchBox.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    }
    
    // Search on category change
    if (categoryFilter) {
        categoryFilter.addEventListener('change', performSearch);
    }
    
    // Make performSearch globally available
    window.performSearch = performSearch;
});
</script>

<style>

.offcanvas {
    z-index: 1080 !important;
}

.offcanvas.show {
    z-index: 1080 !important;
}

.offcanvas-backdrop {
    z-index: 1075 !important;
    background-color: rgba(0, 0, 0, 0.7) !important;
}


.navbar {
    z-index: 1030 !important;
}


.offcanvas .offcanvas-footer {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    padding: 1rem;
}


.offcanvas .btn-close-white {
    filter: brightness(1.2);
    opacity: 0.9;
}

.offcanvas .btn-close-white:hover {
    opacity: 1;
    transform: scale(1.1);
}


.card[data-id] {
    cursor: pointer;
    transition: transform 0.2s ease;
}

.card[data-id]:hover {
    transform: translateY(-2px);
}


.card .btn {
    position: relative;
    z-index: 10;
}
</style>
}

@functions {
    public static HtmlString Highlight(string text, string search)
    {
        if (string.IsNullOrWhiteSpace(search) || string.IsNullOrWhiteSpace(text)) return new HtmlString(text);
        var regex = new System.Text.RegularExpressions.Regex($"({System.Text.RegularExpressions.Regex.Escape(search)})", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
        var highlighted = regex.Replace(text, "<mark>$1</mark>");
        return new HtmlString(highlighted);
    }
}